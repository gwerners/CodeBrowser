<!DOCTYPE html>
<html lang="en" class="history">
   <head>
      <meta name="robots" content="nofollow">
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--%lua%
print("      <link rel=\"stylesheet\" type=\"text/css\" media=\"all\" title=\"Default\" href=\"" .. serverUrl .. "/files/style.css\">\n")
print("      <link rel=\"stylesheet\" type=\"text/css\" href=\"" .. serverUrl .. "/files/jquery.tooltip.css\">\n")
print("      <link rel=\"search\" href=\"" .. serverUrl .. "/opensearch\" type=\"application/opensearchdescription+xml\" title=\"OpenGrok Search for current project(s)\">\n")
print("      <script type=\"text/javascript\" src=\"" .. serverUrl .. "/files/jquery-1.4.4.min.js\"></script>\n")
print("      <script type=\"text/javascript\" src=\"" .. serverUrl .. "/files/jquery.tooltip-1.3.pack.js\"></script>\n")
print("      <script type=\"text/javascript\" src=\"" .. serverUrl .. "/files/utils.js\"></script>\n")
print("      <title>" .. pageTitle .. ": /" .. project .. "/</title>\n")
print("      <link rel=\"search\" href=\"" .. serverUrl .. "/opensearch\" type=\"application/opensearchdescription+xml\" title=\"Search for current project(s)\">\n")
print("      <script type=\"text/javascript\" src=\"" .. serverUrl .. "/files/loader.js\"></script>\n")
%lua%-->


    <style>
        #container {
            width: 100%;
            height: 500px;
        }
        .myLineHighlight {
            background-color: yellow;
            opacity: 0.5;
        }
    </style>
    
   </head>
   <body>
      <script type="text/javascript">/* <![CDATA[ */
         document.hash = 'null';document.rev = '';document.link = '/xref/OpenBSD/usr.sbin/smtpd/smtpd.c';document.annotate = false;
         document.domReady.push(function() {domReadyMast();});
         document.pageReady.push(function() { pageReadyMast();});
         /* ]]> */
      </script>
      <div id="page">
         <div id="whole_header">
            <form action="/search">
               <div id="header">
<!--%lua%
print("                  <a href=\"" .. serverUrl .. "\"></a>\n")
print("                  <div id=\"pagetitle\"><span id=\"filename\">" .. title .. ": " .. project .. "/" .. path .. "</span></div>\n")
%lua%-->   
               </div>
               <div id="Masthead">
<!--%lua%
if (hash == nil or hash == '') then
  print("                  <tt><a href=\"" .. serverUrl .. "/folders?project=" .. project .. "&path=" .. upperPath .. "\">" .. project .. "/" .. path .. "</a>/</tt>\n")
else
  print("                  <tt><a href=\"" .. serverUrl .. "/folders?project=" .. project .. "&path=" .. upperPath .. "\">" .. project .. "/" .. path .. "#" .. hash .. "</a>/</tt>\n")
end
%lua%-->
               </div>
               <div id="bar">
                  <ul>
<!--%lua%
print("                     <li><a href=\"" .. serverUrl .. "\"><span id=\"home\"></span>Home</a></li>\n")
print("                     <li><a href=\"" .. serverUrl .. "/history?project=" .. project .. "&path=" .. path .. "\">History</a></li>\n")
if (hash == nil or hash == '') then
  print("                     <li><a href=\"" .. serverUrl .. "/annotate?project=" .. project .. "&path=" .. path .. "\">Annotate</a></li>\n")
else
  print("                     <li><a href=\"" .. serverUrl .. "/annotate?project=" .. project .. "&path=" .. path .. "&hash=" .. hash .. "\">Annotate</a></li>\n")
end
%lua%-->   
                     <li><a href="#" onclick="javascript:lsttoggle();return false;" title="Show or hide symbol list."><span id="defbox"></span>Navigate</a></li>
                     <li><input type="text" id="search" name="q" class="q" value="">
                        <input type="submit" value="Search" class="submit">
                     </li>
                     <li><input type="checkbox" name="path" value="/OpenBSD/usr.sbin/smtpd/" checked="checked"> only in <b>smtpd.c</b></li>
                  </ul>
                  <input type="hidden" name="project" value="OpenBSD">
               </div>
            </form>
         </div>
         <div id="content" style="top: 32073.5px; bottom: 0px;">
            <script type="text/javascript">/* <![CDATA[ */
               document.pageReady.push(function() { pageReadyList();});
               /* ]]> */
            </script>


    <ul id="fileList" style="overflow-y: auto; max-height: 300px;"></ul>
    <div id="editorContainer" style="height: calc(100vh - 100px);"></div>
    <script>
        const editorContainer = document.getElementById('editorContainer');

        let hoverMemoization = {};
        function getHover(path, line, start,end,json) {
            const key = `${path}_${line}_${start}_${end}`;
            console.log("check key " + key);
            if (hoverMemoization.hasOwnProperty(key)) {
                console.log("key found");
                return hoverMemoization[key];
            } else {
                console.log("key not found");
                if (!json || json.contents[0].value.startsWith("No Info")) {
                    console.log("just a check, return null");
                    return null;
                }
                console.log("store key!");
                const newEntry =  json;
                hoverMemoization[key] = newEntry;
                return newEntry;
            }
        }
        async function fetchHoverInfo(url,lineNumber, column) {
            try {
                console.log(url);
                const response = await fetch(`${url}&line=${lineNumber}&column=${column}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to fetch hover info:', error);
                return null;
            }
        }
        async function fetchDefinition(url, functionName, lineNumber, column) {
            try {
                const response = await fetch(`${url}&function=${functionName}&line=${lineNumber}&column=${column}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message);
                }
                return data;  // Assuming the server response has the file information in result
            } catch (error) {
                console.error('Failed to fetch function definition file:', error);
                return null;
            }
        }
        function loadCppContent(content, lang) {
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' }});
            require(['vs/editor/editor.main'], (monaco) => {
                //"vs" | "vs-dark" | "hc-black" | "hc-light"
                const editor = monaco.editor.create(editorContainer, {
                    value: content,
                    language: lang,
                    theme: 'hc-light'
                });
<!--%lua%
print("                const lineNumber = " .. line .. ";\n");
%lua%-->
                if (lineNumber > 0) {
                    // Reveal line in center
                    editor.revealLineInCenter(lineNumber);

                    // Highlight the line
                    const decoration = {
                        range: new monaco.Range(lineNumber, 1, lineNumber, 1),
                        options: {
                            isWholeLine: true,
                            className: 'myLineHighlight'
                        }
                    };
                    editor.deltaDecorations([], [decoration]);
                }
                editor.onMouseDown(async (event) => {
                    const { event: { ctrlKey }, target } = event;

                    if (ctrlKey) {
                        //const position = target.position;
                        const position = editor.getPosition();
                        if (position) {
                            const lineNumber = position.lineNumber;
                            const column = position.column;
                            const word = editor.getModel().getWordAtPosition(position);
                            if (word) {
                                const itemName = word.word;
                                try {
<!--%lua%
print("                                const definition = await fetchDefinition(\"" .. serverUrl .. "/definition?project=" .. project .. "&path=" .. path .. "\", itemName, lineNumber, column);\n")
%lua%-->
                                    if (definition && definition.uri) {
                                        window.location.href = definition.uri;  // Redirect to the definition location
                                    } else {
                                        console.error('Definition not found');
                                    }
                                } catch (error) {
                                    console.error('Error fetching definition:', error);
                                }
                            }
                        }
                    }
                });




<!--%lua%
print("                monaco.languages.registerHoverProvider('" .. suffix .. "', {\n")
%lua%-->
                    provideHover: async (model, position) => {
                        const lineNumber = position.lineNumber;
                        const column = position.column;
                        const word = editor.getModel().getWordAtPosition(position);
                        if (!word) {
                            console.log("word is null");
                            return null;
                        }
<!--%lua%
print("                        let last = getHover(\"" .. path .. "\", lineNumber, word.startColumn,word.endColumn,null)\n")
%lua%-->
                        if (last) {
                            console.log("last is not null " + JSON.stringify(last));
                            return last;
                        }
                        try {
<!--%lua%
print("                            const hoverInfo = await fetchHoverInfo(\"" .. serverUrl .. "/hover?project=" .. project .. "&path=" .. path .. "\", lineNumber, column);\n")
%lua%-->
                            if (!hoverInfo) {
                                return null;
                            }
                            let ret = {
                                contents: [
                                    { value: hoverInfo.description }
                                ]
                            }
<!--%lua%
print("                            getHover(\"" .. path .. "\", lineNumber, word.startColumn,word.endColumn,ret)\n")
%lua%-->
                            return ret;
                        } catch (error) {
                            console.error('Error fetching hover info:', error);
                            return null;
                        }
                    }

                });

            });
        }
<!--%lua%
print("        let fileUrl = '" .. serverUrl .. "/bin?project=" .. project .. "&path=" .. path .. "&hash=" .. hash .. "'\n")
%lua%-->
        fetch(fileUrl)
            .then(response => response.text())
            .then(data => loadCppContent(data,'cpp'))
            .catch(error => console.error('Error fetching C++ content:', error));
    </script>
            <div id="footer">
<!--%lua%
print("            <p><a href=\"" .. githubUrl .. "\" title=\"Served by " .. serverName .. "\"><span id=\"fti\"></span></a></p>\n")
print("            <div><img src=\"" .. serverUrl .. "/files/1.gif\" style=\"position:absolute; left:-9999px;\" alt=\"\"></div>\n")
print("            <p>Indexes created " .. indexCreationTime .. "</p>\n")
%lua%-->
            </div>
         </div>
      </div>
   </body>
</html>

